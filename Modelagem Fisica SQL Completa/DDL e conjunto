-- ======= TABELAS =======

CREATE TABLE IF NOT EXISTS PACIENTE (
    ID_PACIENTE        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME               VARCHAR2(120) NOT NULL,
    CPF                VARCHAR2(11) NOT NULL UNIQUE,
    DATA_NASCIMENTO    DATE NOT NULL,
    ENDERECO           VARCHAR2(200),
    TELEFONE           VARCHAR2(20),
    PLANO_SAUDE        VARCHAR2(80)
);

CREATE TABLE IF NOT EXISTS PROFISSIONAL (
    ID_PROFISSIONAL    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME               VARCHAR2(120) NOT NULL,
    CPF                VARCHAR2(11) NOT NULL UNIQUE,
    CARGO              VARCHAR2(50) CHECK (CARGO IN ('MEDICO','ENFERMEIRO','TECNICO')),
    ESPECIALIDADE      VARCHAR2(100)
);

CREATE TABLE IF NOT EXISTS SETOR (
    ID_SETOR       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME_SETOR     VARCHAR2(80) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS LEITO (
    ID_LEITO      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_SETOR      NUMBER NOT NULL,
    STATUS_LEITO  VARCHAR2(20) DEFAULT 'LIVRE' 
                  CHECK (STATUS_LEITO IN ('LIVRE','OCUPADO','MANUTENCAO')),
    CONSTRAINT FK_LEITO_SETOR FOREIGN KEY (ID_SETOR)
        REFERENCES SETOR(ID_SETOR)
);

CREATE TABLE IF NOT EXISTS CONSULTA (
    ID_CONSULTA       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_PACIENTE       NUMBER NOT NULL,
    ID_PROFISSIONAL   NUMBER NOT NULL,
    DATA_CONSULTA     DATE NOT NULL,
    PRIORIDADE        VARCHAR2(20) 
                      CHECK (PRIORIDADE IN ('BAIXA','MEDIA','ALTA')),
    DIAGNOSTICO       VARCHAR2(4000),

    CONSTRAINT FK_CONS_PACIENTE FOREIGN KEY (ID_PACIENTE)
        REFERENCES PACIENTE(ID_PACIENTE),

    CONSTRAINT FK_CONS_PROF FOREIGN KEY (ID_PROFISSIONAL)
        REFERENCES PROFISSIONAL(ID_PROFISSIONAL)
);

CREATE TABLE IF NOT EXISTS INTERNACAO (
    ID_INTERNACAO    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_PACIENTE      NUMBER NOT NULL,
    ID_LEITO         NUMBER NOT NULL,
    DATA_ENTRADA     DATE NOT NULL,    -- padronizado: DATA_ENTRADA
    DATA_ALTA        DATE,

    CONSTRAINT FK_INT_PAC FOREIGN KEY (ID_PACIENTE)
        REFERENCES PACIENTE(ID_PACIENTE),

    CONSTRAINT FK_INT_LEITO FOREIGN KEY (ID_LEITO)
        REFERENCES LEITO(ID_LEITO)
);

CREATE TABLE IF NOT EXISTS FATURAMENTO (
    ID_FATURAMENTO    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_CONSULTA       NUMBER,
    ID_INTERNACAO     NUMBER,
    VALOR             NUMBER(10,2) NOT NULL,
    TIPO              VARCHAR2(20) CHECK (TIPO IN ('CONSULTA','INTERNACAO')),
    DATA_FATURAMENTO  DATE DEFAULT SYSDATE,

    CONSTRAINT FK_FAT_CONS FOREIGN KEY (ID_CONSULTA)
        REFERENCES CONSULTA(ID_CONSULTA),

    CONSTRAINT FK_FAT_INT FOREIGN KEY (ID_INTERNACAO)
        REFERENCES INTERNACAO(ID_INTERNACAO)
);

CREATE TABLE IF NOT EXISTS AUDITORIA (
    id_auditoria      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tabela_afetada    VARCHAR2(100) NOT NULL,
    operacao          VARCHAR2(10)  NOT NULL,  -- INSERT / UPDATE / DELETE
    usuario_bd        VARCHAR2(50)  DEFAULT USER,
    data_operacao     DATE          DEFAULT SYSDATE,
    chave_registro    VARCHAR2(200),  -- ID do registro alterado
    valor_antigo      CLOB,
    valor_novo        CLOB
);


CREATE TABLE IF NOT EXISTS ATENDIMENTO (
    ID_ATENDIMENTO     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_PACIENTE        NUMBER NOT NULL,
    ID_PROFISSIONAL    NUMBER NOT NULL,
    DATA_ATENDIMENTO   DATE NOT NULL,
    DESCRICAO          VARCHAR2(4000),

    CONSTRAINT FK_ATT_PACIENTE FOREIGN KEY (ID_PACIENTE)
        REFERENCES PACIENTE(ID_PACIENTE),

    CONSTRAINT FK_ATT_PROFISSIONAL FOREIGN KEY (ID_PROFISSIONAL)
        REFERENCES PROFISSIONAL(ID_PROFISSIONAL)
);


--  TRIGGERS 

-- Quando uma nova internação é inserida: marca leito como OCUPADO
CREATE OR REPLACE TRIGGER TRG_OCUPAR_LEITO
AFTER INSERT ON INTERNACAO
FOR EACH ROW
BEGIN
    UPDATE LEITO
    SET STATUS_LEITO = 'OCUPADO'
    WHERE ID_LEITO = :NEW.ID_LEITO;
END;
/

-- Quando a data de alta é preenchida: libera leito (somente quando DATA_ALTA passou de NULL para não-NULL)
CREATE OR REPLACE TRIGGER TRG_LIBERAR_LEITO
AFTER UPDATE ON INTERNACAO
FOR EACH ROW
BEGIN
    -- somente se houver alta nova (antes NULL e agora NOT NULL)
    IF :OLD.DATA_ALTA IS NULL AND :NEW.DATA_ALTA IS NOT NULL THEN
        UPDATE LEITO
        SET STATUS_LEITO = 'LIVRE'
        WHERE ID_LEITO = :NEW.ID_LEITO;
    END IF;
END;
/

--  PROCEDURES 

CREATE OR REPLACE PROCEDURE CADASTRAR_PACIENTE (
    P_NOME            IN VARCHAR2,
    P_CPF             IN VARCHAR2,
    P_DATA_NASC       IN DATE,
    P_ENDERECO        IN VARCHAR2,
    P_TELEFONE        IN VARCHAR2,
    P_PLANO           IN VARCHAR2
)
AS
BEGIN
    INSERT INTO PACIENTE (NOME, CPF, DATA_NASCIMENTO, ENDERECO, TELEFONE, PLANO_SAUDE)
    VALUES (P_NOME, P_CPF, P_DATA_NASC, P_ENDERECO, P_TELEFONE, P_PLANO);
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        RAISE_APPLICATION_ERROR(-20001, 'CPF já cadastrado.');
END;
/

CREATE OR REPLACE PROCEDURE AGENDAR_CONSULTA (
    P_ID_PACIENTE     IN NUMBER,
    P_ID_PROFISSIONAL IN NUMBER,
    P_DATA            IN DATE,
    P_PRIORIDADE      IN VARCHAR2
)
AS
BEGIN
    INSERT INTO CONSULTA (ID_PACIENTE, ID_PROFISSIONAL, DATA_CONSULTA, PRIORIDADE)
    VALUES (P_ID_PACIENTE, P_ID_PROFISSIONAL, P_DATA, P_PRIORIDADE);
END;
/

--  VIEWS 

CREATE OR REPLACE VIEW VW_CONSULTAS_HOJE_MEDICO AS
SELECT 
    C.ID_CONSULTA,
    P.NOME AS PACIENTE,
    C.DATA_CONSULTA,
    C.PRIORIDADE,
    C.DIAGNOSTICO
FROM CONSULTA C
JOIN PACIENTE P ON P.ID_PACIENTE = C.ID_PACIENTE
WHERE TRUNC(C.DATA_CONSULTA) = TRUNC(SYSDATE);


--  FUNÇÃO 

CREATE OR REPLACE FUNCTION FN_IDADE (P_DATA_NASC DATE)
RETURN NUMBER
AS
BEGIN
    RETURN FLOOR( MONTHS_BETWEEN(SYSDATE, P_DATA_NASC) / 12 );
END;
/

--  PACKAGE 

CREATE OR REPLACE PACKAGE PKG_HOSPITAL AS
    PROCEDURE NOVA_CONSULTA(P_ID_PACIENTE NUMBER, P_ID_PROF NUMBER, P_DATA DATE);
    FUNCTION GET_IDADE(P_ID_PACIENTE NUMBER) RETURN NUMBER;
END PKG_HOSPITAL;
/

CREATE OR REPLACE PACKAGE BODY PKG_HOSPITAL AS

    PROCEDURE NOVA_CONSULTA(P_ID_PACIENTE NUMBER, P_ID_PROF NUMBER, P_DATA DATE) AS
    BEGIN
        INSERT INTO CONSULTA (ID_PACIENTE, ID_PROFISSIONAL, DATA_CONSULTA)
        VALUES (P_ID_PACIENTE, P_ID_PROF, P_DATA);
    END;

    FUNCTION GET_IDADE(P_ID_PACIENTE NUMBER) RETURN NUMBER AS
        V_DATA DATE;
    BEGIN
        SELECT DATA_NASCIMENTO INTO V_DATA FROM PACIENTE
        WHERE ID_PACIENTE = P_ID_PACIENTE;

        RETURN FN_IDADE(V_DATA);
    END;

END PKG_HOSPITAL;
/

-- CONSULTAS AVANÇADAS (corrigidas) 

-- Taxa de ocupação por setor (leitos ocupados / total de leitos)
SELECT s.id_setor,
       s.nome_setor,
       COUNT(l.id_leito) AS total_leitos,
       SUM(CASE WHEN l.status_leito = 'OCUPADO' THEN 1 ELSE 0 END) AS leitos_ocupados,
       ROUND(
            SUM(CASE WHEN l.status_leito = 'OCUPADO' THEN 1 ELSE 0 END) 
            / COUNT(l.id_leito) * 100, 2
       ) AS taxa_ocupacao_pct
FROM setor s
JOIN leito l ON l.id_setor = s.id_setor
GROUP BY s.id_setor, s.nome_setor;

-- Custo total por setor (somatório do faturamento). Ajustado para usar VALOR.
SELECT s.nome_setor,
       SUM(f.valor) AS faturamento_total
FROM setor s
JOIN leito l ON l.id_setor = s.id_setor
JOIN internacao i ON i.id_leito = l.id_leito
JOIN faturamento f ON f.id_internacao = i.id_internacao
GROUP BY s.nome_setor
ORDER BY faturamento_total DESC;

-- Pacientes com mais de 1 internação no ano (HAVING)
SELECT p.id_paciente,
       p.nome,
       COUNT(i.id_internacao) AS qtde_internacoes
FROM paciente p
JOIN internacao i ON i.id_paciente = p.id_paciente
WHERE EXTRACT(YEAR FROM i.data_entrada) = 2025
GROUP BY p.id_paciente, p.nome
HAVING COUNT(i.id_internacao) > 1;

--  INDICES 

CREATE INDEX idx_atendimento_paciente ON atendimento(id_paciente);
CREATE INDEX idx_atendimento_medico ON atendimento(id_profissional);
CREATE INDEX idx_internacao_leito ON internacao(id_leito);
CREATE INDEX idx_faturamento_internacao ON faturamento(id_internacao);
CREATE INDEX idx_leito_status ON leito(status_leito);

--  EXEMPLOS DE CONSULTAS SIMPLES (HITS) 

SELECT 
       a.*
FROM atendimento a
WHERE a.id_paciente = 10;

SELECT 
       p.nome, a.data_atendimento
FROM paciente p
JOIN atendimento a ON a.id_paciente = p.id_paciente;
